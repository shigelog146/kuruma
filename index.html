<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>駐車場登録画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- Leaflet（畑システムと同じ） -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
   body {
     font-size: 20px;
     padding: 15px;
     background: #eef3f7;
     font-family: sans-serif;
   }

   * {
     box-sizing: border-box;
   }

   input,
   button,
   textarea {
     font-size: 20px;
     padding: 10px;
     width: 100%;
     margin-top: 10px;
   }

   textarea {
     min-height: 100px;
     resize: vertical;
   }

   #map {
     height: 350px;
     margin-top: 15px;
   }

   #coords {
     display: flex;
     justify-content: space-between;
     font-size: 16px;
     margin-top: 10px;
     background: #fff;
     padding: 3px 3px;
     border-radius: 8px;
   }

   h2 {
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 8px;
     font-size: 28px;
   }

   h2 i {
     width: 32px;
     height: 32px;
   }
   
  </style>

</head>

<body>

  <h2>
    <i data-lucide="circle-parking"></i>
    まちごと駐車場
  </h2>

  <script src="https://unpkg.com/lucide@latest"></script>  <!-- アイコンライブラリ -->
  <script>lucide.createIcons();</script>

  <input id="title" placeholder="駐車場名を入力">
  <input type="file" id="imageInput">

  <img id="previewImage" style="width:100%; margin-top:15px; display:none;">

  <input id="price" type="number" min="0" inputmode="numeric" placeholder="1日あたり料金（円）">

  <textarea id="comment" placeholder="駐車場の説明・注意点" ></textarea>
  
  <button id="getLocationBtn">現在地を取得</button>
  
  <button id="saveBtn">保存する</button>

  <div id="coords">
     <span id="latDisplay">緯度: --</span>
     <span id="lngDisplay">経度: --</span>
  </div>

  <div id="map"></div>

  <script type="module">

    /* ==============================
       Supabase 初期化
    ============================== */

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const sb = createClient(
      "https://zyvpzobykvuscxuhsrad.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5dnB6b2J5a3Z1c2N4dWhzcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTE0NTAsImV4cCI6MjA4NTM2NzQ1MH0.Z2cKv3VSlk3iibQl7ldwcff9WF5cBHTZkcrdvxA2Bbk",
      {
        auth: {
          persistSession: false,
          autoRefreshToken: false,
        }
      }
    );

    /* ==============================
       画像選択時プレビュー表示
    ============================== */
   document
      .getElementById("imageInput")
      .addEventListener("change", function () {

        const file = this.files[0];

        if (!file) return;

        const reader = new FileReader();

        reader.onload = function (e) {

          const preview = document.getElementById("previewImage");
          preview.src = e.target.result;
          preview.style.display = "block";

        };

        reader.readAsDataURL(file);

      });

    /* ==============================
       地図初期化（Leaflet）
    ============================== */

    let map = L.map('map').setView([34.455339, 131.764480], 14);

    L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {
        attribution: '© OpenStreetMap'
      }
    ).addTo(map);

    let marker;
    let lat, lng;

    /* ==============================
       現在地取得
    ============================== */

    document
      .getElementById("getLocationBtn")
      .addEventListener("click", () => {

        navigator.geolocation.getCurrentPosition(pos => {

          lat = pos.coords.latitude;
          lng = pos.coords.longitude;

            document.getElementById("latDisplay").textContent =
            "緯度: " + lat.toFixed(6);

            document.getElementById("lngDisplay").textContent =
            "経度: " + lng.toFixed(6);

          if (marker) {
            map.removeLayer(marker);
          }

          marker = L.marker([lat, lng], { draggable: true }).addTo(map);
          map.setView([lat, lng], 16);

          /* ドラッグ後に座標更新 */
          marker.on("dragend", function () {
            const position = marker.getLatLng();
            lat = position.lat;
            lng = position.lng;

            document.getElementById("latDisplay").textContent =
            "緯度: " + lat.toFixed(6);

            document.getElementById("lngDisplay").textContent =
            "経度: " + lng.toFixed(6);

            alert("位置を微調整しました");
          });
          alert("位置を取得しました");

        });

      });

      /* ==============================
         画像圧縮（畑システム方式）
      ============================== */
      function compressImage(file) {

        return new Promise((resolve) => {

          const reader = new FileReader();

          reader.onload = function (event) {

            const img = new Image();

            img.onload = function () {

              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");

              const maxWidth = 1200;
              let width = img.width;
              let height = img.height;

              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }

              canvas.width = width;
              canvas.height = height;

              ctx.drawImage(img, 0, 0, width, height);

              canvas.toBlob(
                (blob) => {
                  resolve(blob);
                },
                "image/jpeg",
                0.7   // 圧縮率（0.1〜1.0）
              );

            };

            img.src = event.target.result;
          };

          reader.readAsDataURL(file);

        });

      }

    /* ==============================
       駐車場保存
    ============================== */

    document
  .getElementById("saveBtn")
  .addEventListener("click", async () => {

    if (!lat) {
      alert("先に位置を取得してください");
      return;
    }

    const title = document.getElementById("title").value;
    const file = document.getElementById("imageInput").files[0];

    let imageUrl = null;

    /* 画像をSupabase Storageへ保存 */
    if (file) {
      const fileName = Date.now() + "_" + file.name;
      const compressedFile = await compressImage(file);

      const { error: uploadError } = await sb
        .storage
        .from("parking-images")
        .upload(fileName, compressedFile);

      if (uploadError) {
        alert("画像保存失敗");
        return;
      }

      const { data } = sb
        .storage
        .from("parking-images")
        .getPublicUrl(fileName);

      imageUrl = data.publicUrl;
    }

    const priceInput = document.getElementById("price").value.trim();
    const price = priceInput === "" ? null : Number(priceInput);

    if (price !== null && isNaN(price)) {
      alert("料金は数字で入力してください");
      return;
    }

    const commentInput = document.getElementById("comment").value.trim();
    const comment = commentInput === "" ? null : commentInput;

    /* DB保存 */
    const { error } = await sb
      .from("parking_spaces")
      .insert({
        title,
        latitude: lat,
        longitude: lng,
        image_url: imageUrl,
        price,
        comment
      });

    if (error) {
      console.log(error);
      alert("保存失敗");
    } else {
      alert("保存成功");

      // ==============================
      // 保存後リセット処理
      // ==============================

      // 入力フォームをクリア
      document.getElementById("title").value = "";
      document.getElementById("imageInput").value = "";
      document.getElementById("previewImage").src = "";
      document.getElementById("previewImage").style.display = "none";
      document.getElementById("price").value = "";
      document.getElementById("comment").value = "";

      // 座標表示リセット
      lat = null;
      lng = null;
      document.getElementById("latDisplay").textContent = "緯度: --";
      document.getElementById("lngDisplay").textContent = "経度: --";

      // マーカー削除
      if (marker) {
        map.removeLayer(marker);
        marker = null;
      }

      // 地図を初期位置に戻す
      map.setView([34.455339, 131.764480], 14);
    }

  });

  </script>

</body>
</html>