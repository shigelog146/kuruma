<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è¦³å…‰å®¢ç”¨ é§è»Šå ´ãƒãƒƒãƒ—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ==============================
       Supabase CDNèª­ã¿è¾¼ã¿
       ============================== -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ==============================
       Leafletï¼ˆåœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
       ============================== -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- ==============================
       MarkerClusterï¼ˆãƒ”ãƒ³å¤§é‡è¡¨ç¤ºå¯¾ç­–ï¼‰
       ============================== -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    /* ==============================
       å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
       ============================== */
    body {
      font-size: 20px;
      padding: 15px;
      background: #f7f7f7;
    }

    /* åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #map {
      height: 500px;
    }

    /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      font-size: 18px;
      padding: 8px;
      margin-top: 8px;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ä¸­å¤®é…ç½® */
    h2 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 28px;
    }

    /* Leafletãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ */
    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      box-shadow: none;
      background-color: #fefefe;
      border: 1px solid #7293a8;
      border-radius: 0 !important;
    }
  </style>
</head>

<body>

  <!-- ==============================
       ç¾åœ¨åˆ©ç”¨ä¸­ã‚¨ãƒªã‚¢
       ============================== -->
  <h2><span style="color:#37496b;">ğŸ…¿</span>ã¾ã¡ã”ã¨é§è»Šå ´</h2>

  <div id="currentParking" style="padding:15px;background:#f5f5f5;margin:10px;">
    <h3>ç¾åœ¨åˆ©ç”¨ä¸­ã®é§è»Šå ´</h3>
    <div id="currentInfo">åˆ©ç”¨ä¸­ã®é§è»Šå ´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    <div id="miniMap" style="height:200px;margin-top:10px;display:none;"></div>
  </div>

  <!-- ==============================
       ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢
       ============================== -->
  <h2>åˆ©ç”¨å¯èƒ½ãªé§è»Šå ´</h2>
  <div id="map"></div>

<script>

/* =========================================================
   Supabaseæ¥ç¶šè¨­å®š
   ========================================================= */
const sb = window.supabase.createClient(
  "https://zyvpzobykvuscxuhsrad.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5dnB6b2J5a3Z1c2N4dWhzcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTE0NTAsImV4cCI6MjA4NTM2NzQ1MH0.Z2cKv3VSlk3iibQl7ldwcff9WF5cBHTZkcrdvxA2Bbk"
);

/* =========================================================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾©
   ========================================================= */
let miniMap = null;            // ç¾åœ¨åˆ©ç”¨ä¸­ã®å°åœ°å›³
let miniMarker = null;         // å°åœ°å›³ãƒãƒ¼ã‚«ãƒ¼
let currentSelectedId = null;  // ç¾åœ¨åˆ©ç”¨ä¸­ID
let overlayLayer = null;       // ï¼ˆæœªä½¿ç”¨å¤‰æ•°ï¼‰
let popupOpen = false;
/* ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥IDï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ */
let myUserId = localStorage.getItem("myParkingUserId");
if (!myUserId) {
  myUserId = crypto.randomUUID();
  localStorage.setItem("myParkingUserId", myUserId);
}

let firstLoad = true; // åˆå›èª­ã¿è¾¼ã¿åˆ¤å®šãƒ•ãƒ©ã‚°

/* =========================================================
   ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ—åˆæœŸåŒ–
   ========================================================= */
let map = L.map('map').setView([35.0, 135.0], 14);

/* OpenStreetMapã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ */
L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { attribution: 'Â© OpenStreetMap' }
).addTo(map);

/* ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒãƒ¼ã‚«ãƒ¼è¨­å®š */
let markerGroup = L.markerClusterGroup({
  chunkedLoading: true,
  chunkInterval: 200,
  chunkDelay: 50
});
map.addLayer(markerGroup);

/* =========================================================
   é§è»Šå ´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
   ========================================================= */
async function loadParking() {

  markerGroup.clearLayers(); // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤

  let query = sb
    .from("parking_spaces")
    .select("id,title,price,latitude,longitude,is_available,rented_by,image_url");

  /* åˆå›ä»¥å¤–ã¯ç¾åœ¨è¡¨ç¤ºç¯„å›²ã®ã¿å–å¾— */
  if (!firstLoad) {
    const bounds = map.getBounds();

    query = query
      .gte("latitude", bounds.getSouth())
      .lte("latitude", bounds.getNorth())
      .gte("longitude", bounds.getWest())
      .lte("longitude", bounds.getEast());
  }

  const { data, error } = await query;

  console.log("å–å¾—ãƒ‡ãƒ¼ã‚¿:", data);
  console.log("å–å¾—ã‚¨ãƒ©ãƒ¼:", error);

  if (error) {
    console.log(error);
    return;
  }

  if (!data || data.length === 0) {
    return;
  }

  let latlngs = [];
  let myParking = null;

  data.forEach(space => {

    /* è‡ªåˆ†ãŒåˆ©ç”¨ä¸­ã‹åˆ¤å®š */
    if (space.rented_by === myUserId) {
      myParking = space;
    }

    /* ä»–äººåˆ©ç”¨ä¸­ã¯éè¡¨ç¤º */
    if (!space.is_available && space.rented_by !== myUserId) {
      return;
    }

    const lat = Number(space.latitude);
    const lng = Number(space.longitude);

    latlngs.push([lat, lng]);

    const marker = L.marker([lat, lng]);

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”Ÿæˆ */
    marker.bindPopup(`
      <div style="font-family: 'Segoe UI', sans-serif; padding: 10px; max-width: 250px;">
        <h3 style="margin: 0 0 8px; font-size: 28px; color: #2c3e50;">
          ${space.title}
        </h3>
        <p style="margin: 0 0 12px; color: #e74c3c; font-size: 28px; font-weight: bold;">
          ï¿¥${space.price.toLocaleString()} / 1æ—¥åˆ©ç”¨
        </p>
        <div style="text-align: center;">
          <button 
            onclick="useParking('${space.id}')" 
            style="
              background-color: #7293a8;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 0;
              cursor: pointer;
              font-size: 24px;
              display: inline-flex;
              align-items: center;
              gap: 6px;
            "
          >
            åˆ©ç”¨ã™ã‚‹
          </button>
        </div>
      </div>
    `, {
      autoPan: false
    });

    markerGroup.addLayer(marker);
  });

  /* åˆå›ã®ã¿è‡ªå‹•ã‚ºãƒ¼ãƒ  */
  if (firstLoad && latlngs.length > 0) {
    map.fitBounds(latlngs);
    firstLoad = false;
  }

  updateCurrentArea(myParking);
}

/* =========================================================
   ç¾åœ¨åˆ©ç”¨ä¸­ã‚¨ãƒªã‚¢UIæ›´æ–°
   ========================================================= */
function updateCurrentArea(space) {

  if (!space) {
    document.getElementById("currentInfo").innerHTML =
      "åˆ©ç”¨ä¸­ã®é§è»Šå ´ã¯ã‚ã‚Šã¾ã›ã‚“";

    if (miniMap) {
      miniMap.remove();
      miniMap = null;
    }

    document.getElementById("miniMap").style.display = "none";
    return;
  }

  currentSelectedId = space.id;

  document.getElementById("currentInfo").innerHTML = `
    <div style="font-family:sans-serif;">
      <h4 style="margin-bottom:8px;">${space.title}</h4>

      ${space.image_url ? `
        <img src="${space.image_url}"
          style="width:100%;max-height:200px;height:180px;object-fit:contain;
          margin-bottom:10px;border:1px solid #ccc;background:#fff;">
      ` : ""}

      <p style="font-size:18px;color:red;margin:5px 0;">
        ${space.price} å††
      </p>

      <button onclick="cancelParking('${space.id}')">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹
      </button>

      <button onclick="openGoogleMap(${space.latitude},${space.longitude})">
        Googleãƒãƒƒãƒ—ã§é–‹ã
      </button>
    </div>
  `;

  document.getElementById("miniMap").style.display = "block";

  if (miniMap) {
    miniMap.remove();
  }

  miniMap = L.map('miniMap')
    .setView([space.latitude, space.longitude], 17);

  L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
  ).addTo(miniMap);

  miniMarker = L.marker([space.latitude, space.longitude])
    .addTo(miniMap);
}

/* =========================================================
   åœ°å›³ç§»å‹•å¾Œã«å†å–å¾—
   ========================================================= */
    map.on("moveend", () => {
      loadParking();
    });

    /* åˆæœŸãƒ­ãƒ¼ãƒ‰ */
    loadParking();

/* =========================================================
   Realtimeæ›´æ–°ç›£è¦–
   ========================================================= */
sb.channel('parking-channel')
  .on(
    'postgres_changes',
    { event: 'UPDATE', schema: 'public', table: 'parking_spaces' },
    (payload) => {

      const newRow = payload.new;
      const bounds = map.getBounds();

      if (
        newRow.latitude >= bounds.getSouth() &&
        newRow.latitude <= bounds.getNorth() &&
        newRow.longitude >= bounds.getWest() &&
        newRow.longitude <= bounds.getEast()
      ) {
        loadParking();
      }
    }
  )
  .subscribe();

/* =========================================================
   åˆ©ç”¨å‡¦ç†
   ========================================================= */
async function useParking(id) {

  console.log("åˆ©ç”¨é–‹å§‹:", id);

  if (currentSelectedId) {
    console.log("ã™ã§ã«åˆ©ç”¨ä¸­");
    return;
  }

  const { data, error } = await sb
    .from("parking_spaces")
    .update({
      is_available: false,
      rented_by: myUserId
    })
    .eq("id", id)
    .eq("is_available", true)
    .select();

  console.log("æ›´æ–°çµæœ:", data);
  console.log("ã‚¨ãƒ©ãƒ¼:", error);

  if (error) {
    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    return;
  }

  if (!data || data.length === 0) {
    alert("ã™ã§ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  currentSelectedId = id;

  await loadParking();
}

/* =========================================================
   ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
   ========================================================= */
async function cancelParking(id) {

  currentSelectedId = null;

  await sb
    .from("parking_spaces")
    .update({
      is_available: true,
      rented_by: null
    })
    .eq("id", id)
    .eq("rented_by", myUserId);

  loadParking();
}

/* =========================================================
   Googleãƒãƒƒãƒ—èµ·å‹•
   ========================================================= */
function openGoogleMap(lat, lng) {
  const url = `https://www.google.com/maps?q=${lat},${lng}`;
  window.open(url, "_blank");
}

</script>
</body>
</html>