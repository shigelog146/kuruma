<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>観光客用 駐車場マップ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
  font-size:20px;
  padding:15px;
  background:#f7f7f7;
}
#map{
  height:500px;
}
button{
  font-size:18px;
  padding:8px;
  margin-top:8px;
}

h2 {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 28px;
}

h2 i {
  width: 32px;
  height: 32px;
}
</style>
</head>
<body>

<h2>
 <i data-lucide="circle-parking"></i>
 まちごと駐車場
</h2>

<script src="https://unpkg.com/lucide@latest"></script>  
<script>lucide.createIcons();</script>

<div id="currentParking" style="padding:15px; background:#f5f5f5; margin:10px;">
  <h3>現在利用中の駐車場</h3>
  <div id="currentInfo">利用中の駐車場はありません</div>
  <div id="miniMap" style="height:200px; margin-top:10px; display:none;"></div>
</div>

<h2>利用可能な駐車場</h2>

<div id="map"></div>

<script>
const sb = window.supabase.createClient(
  "https://zyvpzobykvuscxuhsrad.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5dnB6b2J5a3Z1c2N4dWhzcmFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3OTE0NTAsImV4cCI6MjA4NTM2NzQ1MH0.Z2cKv3VSlk3iibQl7ldwcff9WF5cBHTZkcrdvxA2Bbk"
);

let miniMap = null;
let miniMarker = null;

// 選択中の駐車場ID
let currentSelectedId = null;

// マップ全体を白くするオーバーレイヤー
let overlayLayer = null;

let map = L.map('map').setView([35.0,135.0],14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

let markerGroup = L.layerGroup().addTo(map);

async function loadParking(){
  markerGroup.clearLayers();

  const { data, error } = await sb
    .from("parking_spaces")
    .select("*")
    .eq("is_available",true);

  if(error){
    console.log(error);
    return;
  }

  const markers = [];

  data.forEach(space=>{
    const marker = L.marker([space.latitude,space.longitude]);

marker.bindPopup(`
  <div style="font-family: 'Segoe UI', sans-serif; padding: 10px; max-width: 250px;">
    <h3 style="margin: 0 0 8px; font-size: 28px; color: #2c3e50;">
      ${space.title}
    </h3>
    <p style="margin: 0 0 12px; color: #e74c3c; font-size: 28px; font-weight: bold;">
      ￥${space.price.toLocaleString()} / 利用
    </p>
    <button 
      onclick="useParking('${space.id}')" 
      style="
        background-color: #3498db;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 24px;
      "
    >
      <i data-lucide="circle-parking"></i> 到着・利用する
    </button>
  </div>
`);


    markerGroup.addLayer(marker);
    markers.push(marker);
  });

  if (markers.length > 0) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds());
  }
}

loadParking();

async function useParking(id){
  // 1つしか選択できない
  if(currentSelectedId) return;
  currentSelectedId = id;

  const { data: space } = await sb
    .from("parking_spaces")
    .select("*")
    .eq("id", id)
    .single();

  // 利用履歴追加
  await sb.from("parking_usage").insert({ parking_id: id });

  // 空き状態を false にする
  await sb
    .from("parking_spaces")
    .update({ is_available:false })
    .eq("id",id);

  // 利用中表示
  document.getElementById("currentInfo").innerHTML = `
    <h4>${space.title}</h4>
    <p style="font-size:18px; color:red;">
      ${space.price} 円
    </p>
    <button onclick="cancelParking('${id}')">
      キャンセルする
    </button>
    <button onclick="openGoogleMap(${space.latitude}, ${space.longitude})">
      Googleマップで開く
    </button>
  `;

  // 小マップ表示
  const miniMapDiv = document.getElementById("miniMap");
  miniMapDiv.style.display = "block";

  if(miniMap){
    miniMap.remove();
  }

  miniMap = L.map('miniMap').setView(
    [space.latitude, space.longitude], 
    17
  );

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
  }).addTo(miniMap);

  miniMarker = L.marker([space.latitude, space.longitude])
    .addTo(miniMap);

  // ==========================
  // マップ全体を白くするオーバーレイヤー
  // ==========================
  const bounds = map.getBounds();
  overlayLayer = L.rectangle(bounds, {
    color: '#ffffff',
    weight: 0,
    fillOpacity: 0.7, // 白の濃さ
    interactive: false
  }).addTo(map);

  // 選択駐車場だけ前面に出す
  markerGroup.eachLayer(marker=>{
    if(marker.getLatLng().lat === space.latitude && marker.getLatLng().lng === space.longitude){
      marker.setZIndexOffset(1000);
      marker.openPopup();
    }
  });

  loadParking();
}

async function cancelParking(id){
  currentSelectedId = null;

  // 空きに戻す
  await sb
    .from("parking_spaces")
    .update({ is_available:true })
    .eq("id",id);

  // 利用履歴削除（最後の1件）
  await sb
    .from("parking_usage")
    .delete()
    .eq("parking_id", id)
    .order("used_at", { ascending:false })
    .limit(1);

  // 画面表示初期化
  document.getElementById("currentInfo").innerHTML =
    "利用中の駐車場はありません";

  // 小マップ破棄
  if(miniMap){
    miniMap.remove();
    miniMap = null;
  }
  document.getElementById("miniMap").style.display = "none";

  // マップの白オーバーレイヤー削除
  if(overlayLayer){
    overlayLayer.remove();
    overlayLayer = null;
  }

  loadParking();
}

// ==============================
// Googleマップを新しいタブで開く
// ==============================
function openGoogleMap(lat, lng){
  const url = `https://www.google.com/maps?q=${lat},${lng}`;
  window.open(url, "_blank");
}
</script>
</body>
</html>